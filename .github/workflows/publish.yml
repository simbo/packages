name: Publish ğŸš›

on:
  push:
    tags:
      - '*/v*.*.*'
      - '!changelog/v*'
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Workspace folder (e.g. "my-pkg")'
        type: string
        required: true
      version:
        description: 'Version (e.g. "1.2.3")'
        type: string
        required: true

run-name: >
  ${{
    format(
      '{0} {1}',
      github.workflow,
      github.event_name == 'workflow_dispatch'
        && format('{0}/v{1}', github.event.inputs.workspace, github.event.inputs.version)
        || github.ref_name
    )
  }}

concurrency:
  cancel-in-progress: false
  group: >
    ${{
      format(
        '{0}--{1}',
        github.workflow,
        github.event_name == 'workflow_dispatch'
        && format('{0}/v{1}', github.event.inputs.workspace, github.event.inputs.version)
        || github.ref_name
      )
    }}

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸªª Retrieve Credentials
        id: credentials
        uses: simbo-actions/actions/actions/github-app-credentials@main
        with:
          app-id: ${{ secrets.SIMBO_GITHUB_APP_ID }}
          app-private-key: ${{ secrets.SIMBO_GITHUB_APP_PRIVATE_KEY }}

      - name: ğŸ§¾ Prepare Publish Params
        id: params
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          WORKSPACE: ${{ github.event.inputs.workspace }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          # Set tag, version and workspace based on the event type
          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            workspace="${WORKSPACE}"
            if [[ "$workspace" =~ [^a-zA-Z0-9._-] ]]; then
              echo "::error title=Invalid Workspace::Workspace may only contain letters, numbers, dot, underscore, hyphen."
              exit 1
            fi
            version="${VERSION}"
            if [[ "$version" =~ [^0-9.] ]]; then
              echo "::error title=Invalid Version::Version may only contain numbers and dots."
              exit 1
            fi
            tag="${workspace}/v${version}"
          else
            tag="${REF_NAME}"
            workspace="${tag%%/v*}"
            version="${tag##*/v}"
          fi

          # Fail if no parameters are set
          for var in workspace version tag; do
            if [[ -z "${!var}" ]]; then
              echo "::error title=Missing ${var^}::${var^} must be set."
              exit 1
            fi
          done

          # Output params
          for var in workspace version tag; do
            echo "$var=${!var}" >> $GITHUB_OUTPUT
          done

      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.credentials.outputs.token }}
          ref: ${{ steps.params.outputs.tag }}

      - name: ğŸšš Install pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          token: ${{ steps.credentials.outputs.token }}
          cache: 'pnpm'
          node-version-file: '.nvmrc'
          registry-url: https://registry.npmjs.org

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§¾ Get Package Name and Private Field
        id: package
        env:
          WORKSPACE: ${{ steps.params.outputs.workspace }}
        run: |
          set -euo pipefail

          packageName=$(jq -r '.name' "packages/${WORKSPACE}/package.json")
          packagePrivate=$(jq -r '.private // false' "packages/${WORKSPACE}/package.json")

          echo "name=${packageName}" >> $GITHUB_OUTPUT
          echo "private=${packagePrivate}" >> $GITHUB_OUTPUT

      - name: ğŸ§¾ Get Release Date and Description
        id: release
        env:
          WORKSPACE: ${{ steps.params.outputs.workspace }}
          VERSION: ${{ steps.params.outputs.version }}
        run: |
          set -euo pipefail

          workspace="${WORKSPACE}"
          version="${VERSION}"
          changelogFile="packages/${workspace}/CHANGELOG.md"
          releaseDate=$(TZ="Europe/Berlin" date +%Y-%m-%d\ %H:%M:%S\ %Z)
          description=""

          # Fail if the changelog file does not exist
          if [[ ! -f "$changelogFile" ]]; then
            echo "::error title=Missing Changelog File::Changelog file not found: $changelogFile"
            exit 1
          fi

          # Extract the respective version's section from the changelog and remove leading and trailing whitespace
          description=$(awk -v ver="## ${version}" '
              $0 == ver { found=1; next }
              found && /^## / { exit }
              found { print }
            ' "$changelogFile" | \
            awk 'BEGIN{found=0} NF{found=1} found{print}' | tac | \
            awk 'BEGIN{found=0} NF{found=1} found{print}' | tac)

          # Fail if no description is set
          if [[ -z "$description" ]]; then
            echo "::error title=Missing Changelog Section::Section for ${version} could not be found in changelog: $changelogFile"
            exit 1
          fi

          # Output date and description
          echo "date=${releaseDate}" >> $GITHUB_OUTPUT
          {
            echo "description<<EOF"
            echo "$description"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ Build Package
        env:
          PACKAGE: ${{ steps.package.outputs.name }}
        run: pnpm run build --filter="${PACKAGE}"

      - name: ğŸš› Publish to Registry
        if: ${{ steps.package.outputs.private == 'false' }}
        working-directory: packages/${{ steps.params.outputs.workspace }}
        run: npm publish

      - name: âš«ï¸ Create Tarball
        id: tarball
        env:
          PACKAGE: ${{ steps.package.outputs.name }}
        run: |
          set -euo pipefail

          # Create a tarball and get the tarball path
          tarballAbsPath=$(pnpm pack --filter="${PACKAGE}" | tail -n 1)
          tarballRelPath=$(realpath --relative-to=$(pwd) $tarballAbsPath)

          # Fail if the tarball file does not exist
          if [[ ! -f "$tarballRelPath" ]]; then
            echo "::error title=Missing Tarball::Tarball not found: $tarballRelPath"
            exit 1
          fi

          # Output tarball path
          echo "path=${tarballRelPath}" >> $GITHUB_OUTPUT

      - name: ğŸ Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.params.outputs.tag }}
          name: ${{ steps.package.outputs.name }} v${{ steps.params.outputs.version }}
          body: |
            _${{ steps.release.outputs.date }}_

            ${{ steps.release.outputs.description }}
          artifacts: ${{ steps.tarball.outputs.path }}
          token: ${{ steps.credentials.outputs.token }}
          makeLatest: true
