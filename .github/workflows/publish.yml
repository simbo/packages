name: ' Publish ðŸš›'

on:
  push:
    tags:
      - '*/v*.*.*'
      - '!changelog/v*'
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Workspace folder (e.g. "my-pkg")'
        type: string
        required: true
      version:
        description: 'Version (e.g. "1.2.3")'
        type: string
        required: true

run-name: >
  ${{
    format(
      '{0} {1}',
      github.workflow,
      github.event_name == 'workflow_dispatch'
        && format('{0}/v{1}', github.event.inputs.workspace, github.event.inputs.version)
        || github.ref_name
    )
  }}

concurrency:
  cancel-in-progress: false
  group: >
    ${{
      format(
        '{0}--{1}',
        github.workflow,
        github.event_name == 'workflow_dispatch'
        && format('{0}/v{1}', github.event.inputs.workspace, github.event.inputs.version)
        || github.ref_name
      )
    }}

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸªª Retrieve Credentials
        id: credentials
        uses: simbo-actions/actions/actions/github-app-credentials@main
        with:
          app-id: ${{ secrets.SIMBO_GITHUB_APP_ID }}
          app-private-key: ${{ secrets.SIMBO_GITHUB_APP_PRIVATE_KEY }}

      - name: ðŸ§¾ Prepare Publish Params
        id: params
        uses: actions/github-script@v8
        env:
          EVENT_NAME: ${{ github.event_name || '' }}
          REF_NAME: ${{ github.ref_name || '' }}
          WORKSPACE: ${{ github.event.inputs.workspace || '' }}
          VERSION: ${{ github.event.inputs.version || '' }}
        with:
          script: |
            const eventName = process.env.EVENT_NAME.trim();

            let workspace, version;

            switch (eventName) {
              case 'workflow_dispatch':
                workspace = process.env.WORKSPACE.trim();
                version = process.env.VERSION.trim();
                break;
              case 'push':
                const ref = process.env.REF_NAME.trim();
                workspace = ref.split('/v')[0];
                version = ref.split('/v')[1];
                break;
              default:
                throw new Error(`Unsupported event name: ${eventName}`);
            }

            if (!/^[\da-z._-]+$/i.test(workspace)) {
              core.setFailed(`Invalid Workspace: Workspace may only contain letters, numbers, dot, underscore, hyphen.`);
              return;
            }
            if (!/^[\d.]+$/.test(version)) {
              core.setFailed(`Invalid Version: Version may only contain numbers and dots.`);
              return;
            }

            const tag = `${workspace}/v${version}`;

            core.setOutput('workspace', workspace);
            core.setOutput('version', version);
            core.setOutput('tag', tag);

      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.credentials.outputs.token }}
          ref: ${{ steps.params.outputs.tag }}

      - name: ðŸšš Install pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version-file: .nvmrc

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§¾ Get Package Name and Private Field
        id: package
        env:
          WORKSPACE: ${{ steps.params.outputs.workspace }}
        run: |
          set -euo pipefail

          packageName=$(jq -r '.name' "packages/${WORKSPACE}/package.json")
          packagePrivate=$(jq -r '.private // false' "packages/${WORKSPACE}/package.json")

          echo "name=${packageName}" >> $GITHUB_OUTPUT
          echo "private=${packagePrivate}" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Build Package
        env:
          PACKAGE: ${{ steps.package.outputs.name }}
        run: pnpm exec turbo run build --filter="${PACKAGE}"

      - name: ðŸš› Publish to Registry
        if: ${{ steps.package.outputs.private == 'false' }}
        env:
          PACKAGE: ${{ steps.package.outputs.name }}
        run: pnpm publish --filter="${PACKAGE}" --no-git-checks --provenance

      - name: ðŸŽ‰ Package Published (Event)
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: package-published
          token: ${{ steps.credentials.outputs.token }}
          client-payload: >
            ${{
              format(
                '{{ "name": {0}, "version": {1} }}',
                toJson(steps.package.outputs.name),
                toJson(steps.params.outputs.version)
              )
            }}
