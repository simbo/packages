name: ' Checks ðŸ§'

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

run-name: >
  ${{
    format(
      '{0} {1}',
      github.workflow,
      github.event_name == 'pull_request'
        && format('PR#{0} "{1}"', github.event.pull_request.number, github.event.pull_request.title)
        || format('Branch {0} "{1}"', github.ref_name, github.event.head_commit.message)
    )
  }}

concurrency:
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
  group: >
    ${{
      format(
        '{0}--{1}',
        github.workflow,
        github.event_name == 'pull_request'
          && github.event.pull_request.number
          || github.ref_name
      )
    }}

permissions:
  contents: write

env:
  REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸªª Retrieve Credentials
        id: credentials
        uses: simbo-actions/actions/actions/github-app-credentials@main
        with:
          app-id: ${{ secrets.SIMBO_GITHUB_APP_ID }}
          app-private-key: ${{ secrets.SIMBO_GITHUB_APP_PRIVATE_KEY }}

      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ steps.credentials.outputs.token }}
          ref: ${{ env.REF }}

      - name: ðŸšš Install pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version-file: .nvmrc

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ‘· Build
        run: pnpm run each:build

      - name: ðŸ“¦ Bundle
        run: pnpm run each:bundle

      - name: ðŸ‘¨â€ðŸ”¬ Tests
        run: pnpm run test

      - name: ðŸ‘¨â€ðŸ« Checks
        run: pnpm run each:check && pnpm run check

      - name: ðŸ“˜ Docs
        run: pnpm run docs

      - name: ðŸ“„ Check for Changesets
        id: has-changesets
        run: |
          set -euo pipefail
          result=$([[ -d .changeset ]] && find .changeset -type f -name '*.md' -print -quit | grep -q . && echo true || echo false)
          echo "result=${result}" >> $GITHUB_OUTPUT

      - name: ðŸ‘®â€â™‚ï¸ Pull Requests Must Have Changesets
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.draft == false
        env:
          RESULT: ${{ steps.has-changesets.outputs.result }}
        run: |
          set -euo pipefail
          if [[ "$RESULT" != "true" ]]; then
            echo "::error title=Missing Changeset::Pull requests must have changesets."
            exit 1
          fi

      - name: 'ðŸŽ‰ Workflow: Release (Event)'
        if: >
          github.event_name == 'push' &&
          steps.has-changesets.outputs.result == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: workflow:release
          token: ${{ steps.credentials.outputs.token }}
          client-payload: >
            ${{
              format(
                '{{ "ref": {0} }}',
                toJson(env.REF)
              )
            }}
