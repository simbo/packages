name: ' Release ðŸ·ï¸'

on:
  repository_dispatch:
    types:
      - workflow:release
  workflow_dispatch:
    inputs:
      ref:
        description: Ref
        type: string
        required: true
        default: 'main'

run-name: >
  ${{
    format(
      '{0} Branch {1}',
      github.workflow,
      github.event_name == 'repository_dispatch' && github.event.client_payload.ref || github.event.inputs.ref
    )
  }}

concurrency:
  cancel-in-progress: false
  group: >
    ${{
      format(
        '{0}--{1}',
        github.workflow,
        github.event_name == 'repository_dispatch' && github.event.client_payload.ref || github.event.inputs.ref
      )
    }}

permissions:
  contents: write

env:
  REF: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.ref || github.event.inputs.ref }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸªª Retrieve Credentials
        id: credentials
        uses: simbo-actions/actions/actions/github-app-credentials@main
        with:
          app-id: ${{ secrets.SIMBO_GITHUB_APP_ID }}
          app-private-key: ${{ secrets.SIMBO_GITHUB_APP_PRIVATE_KEY }}

      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.credentials.outputs.token }}
          ref: ${{ env.REF }}

      - name: ðŸšš Install pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          token: ${{ steps.credentials.outputs.token }}
          cache: pnpm
          node-version-file: .nvmrc

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”„ Integrate Changesets and Sync Versions
        run: |
          set -euo pipefail

          # changesets need a working prettier config, therefor the prettier-config package needs to be build first
          pnpm exec turbo run build --filter='@simbo/prettier-config'

          # integrate changesets
          pnpm exec changeset version

          # update lockfile
          pnpm install

      - name: ðŸ§¾ Get Bumped Packages
        id: bumped-packages
        run: |
          set -euo pipefail

          # Get the names of changes files
          changedFiles=$(git diff --name-only HEAD)

          # Initialize an array of package versions for release
          packages=()

          # Loop through the changed files and check for package.json files.
          # Check if the package.json has a version change, extract the package folder name and version.
          # Join them with a slash and add it to the released packages list.
          for file in $changedFiles; do
            if [[ "$file" =~ ^packages/.+/package\.json$ ]]; then
              oldVersion=$(git show HEAD:"$file" | jq -r .version 2>/dev/null || echo)
              newVersion=$(jq -r .version "$file")
              if [[ -n "$oldVersion" && -n "$newVersion" && "$oldVersion" != "$newVersion" ]]; then
                pkgFolder=$(basename "$(dirname "$file")")
                packages+=("${pkgFolder}/v${newVersion}")
              fi
            fi
          done

          # Fail if no packages are found
          if [[ ${#packages[@]} -eq 0 ]]; then
            echo "::error title=No Packages Found::No packages were found to release."
            exit 1
          fi

          # Print and output the packages
          echo "packages=${packages[*]}"
          echo "packages=${packages[*]}" >> $GITHUB_OUTPUT

      - name: ðŸ“ Update Packages List Docs
        run: pnpm run packages-list

      - name: ðŸ’¾ Commit & Push Changes
        uses: simbo-actions/actions/actions/commit-and-push@main
        with:
          ref: ${{ env.REF }}
          name: ${{ steps.credentials.outputs.name }}
          email: ${{ steps.credentials.outputs.email }}
          message: 'ci(release): ${{ steps.bumped-packages.outputs.packages }}'
          tags: ${{ steps.bumped-packages.outputs.packages }}

      - name: ðŸŽ‰ Release Commit Created (Event)
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: release-commit-created
          token: ${{ steps.credentials.outputs.token }}
          client-payload: >
            ${{
              format(
                '{{ "ref": {0}, "packages": {1} }}',
                toJson(env.REF),
                toJson(steps.bumped-packages.outputs.packages)
              )
            }}
